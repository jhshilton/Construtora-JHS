<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtora JHS - Dashboard</title>
    
    <!-- Firebase SDK v9 (modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, query, where, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC5cnKYsZ5wCI8Aeho0KEmeFTSxtDd0AkY",
            authDomain: "construtora-jhs-2693d.firebaseapp.com",
            projectId: "construtora-jhs-2693d",
            storageBucket: "construtora-jhs-2693d.appspot.com",
            messagingSenderId: "358435009217",
            appId: "1:358435009217:web:2e11ec33ee15a8b7ac9a40"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const { jsPDF } = window.jspdf;

        // Variáveis globais
        let currentUser = null;
        let selectedFile = null;
        let activeProjectId = null;

        // Verificação de autenticação
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "index.html";
            } else {
                currentUser = user;
                console.log("Usuário autenticado:", currentUser.uid);
                loadProjects();
            }
        });

        // Logout
        document.getElementById("logout-btn").addEventListener("click", () => {
            signOut(auth);
        });

        // Carregar lista de obras
        async function loadProjects() {
            try {
                const q = query(
                    collection(db, "projects"),
                    where("userId", "==", currentUser.uid),
                    orderBy("lastUpdate", "desc")
                );
                const querySnapshot = await getDocs(q);
                const projectSelect = document.getElementById("project-select");
                projectSelect.innerHTML = '<option value="">Selecione uma obra</option>';

                querySnapshot.forEach((doc) => {
                    const project = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent = `${project.name} (${project.status === 'active' ? 'Ativa' : 'Concluída'})`;
                    projectSelect.appendChild(option);
                    if (project.status === 'active' && !activeProjectId) {
                        activeProjectId = doc.id;
                        projectSelect.value = doc.id;
                    }
                });

                if (activeProjectId) {
                    await loadProjectData(activeProjectId);
                    await loadPayments();
                    await loadExtras();
                    await loadReceipts();
                    await updateReport();
                }
                console.log("Obras carregadas, obra ativa:", activeProjectId);
            } catch (error) {
                console.error("Erro ao carregar obras:", error);
                showToast("Erro ao carregar obras", true);
            }
        }

        // Selecionar obra ativa
        document.getElementById("project-select").addEventListener("change", async (e) => {
            activeProjectId = e.target.value;
            console.log("Obra ativa selecionada:", activeProjectId);
            if (activeProjectId) {
                await loadProjectData(activeProjectId);
                await loadPayments();
                await loadExtras();
                await loadReceipts();
                await updateReport();
            } else {
                clearProjectForm();
            }
        });

        // Criar nova obra
        document.getElementById("new-project-btn").addEventListener("click", async () => {
            try {
                const projectData = {
                    name: "Nova Obra",
                    value: 0,
                    startDate: "",
                    description: "",
                    userId: currentUser.uid,
                    status: "active",
                    lastUpdate: new Date()
                };
                const docRef = await addDoc(collection(db, "projects"), projectData);
                activeProjectId = docRef.id;
                console.log("Nova obra criada:", activeProjectId);
                await loadProjects();
                showToast("Nova obra criada com sucesso!");
            } catch (error) {
                console.error("Erro ao criar nova obra:", error);
                showToast("Erro ao criar nova obra", true);
            }
        });

        // Concluir obra
        document.getElementById("complete-project-btn").addEventListener("click", async () => {
            if (!activeProjectId) {
                showToast("Nenhuma obra selecionada!", true);
                return;
            }
            if (confirm("Tem certeza que deseja concluir esta obra?")) {
                try {
                    await updateDoc(doc(db, "projects", activeProjectId), { status: "completed", lastUpdate: new Date() });
                    activeProjectId = null;
                    await loadProjects();
                    clearProjectForm();
                    showToast("Obra concluída com sucesso!");
                } catch (error) {
                    console.error("Erro ao concluir obra:", error);
                    showToast("Erro ao concluir obra", true);
                }
            }
        });

        // Carregar dados da obra
        async function loadProjectData(projectId) {
            try {
                const docRef = doc(db, "projects", projectId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Dados da obra carregados:", data);
                    document.getElementById("project-name").value = data.name || "";
                    document.getElementById("project-value").value = formatCurrencyInputValue(data.value || 0);
                    document.getElementById("project-start").value = data.startDate || "";
                    document.getElementById("project-description").value = data.description || "";
                } else {
                    console.log("Nenhum dado de obra encontrado para o ID:", projectId);
                    clearProjectForm();
                }
            } catch (error) {
                console.error("Erro ao carregar obra:", error);
                showToast("Erro ao carregar dados da obra", true);
            }
        }

        // Salvar dados da obra
        document.getElementById("save-project-btn").addEventListener("click", async () => {
            if (!activeProjectId) {
                showToast("Selecione ou crie uma obra antes de salvar!", true);
                return;
            }
            try {
                const projectValueRaw = document.getElementById("project-value").value;
                const projectValue = parseFloat(projectValueRaw.replace(/\./g, "").replace(",", ".")) || 0;
                if (isNaN(projectValue) || projectValue < 0) {
                    showToast("Insira um valor válido para a obra!", true);
                    return;
                }

                const projectData = {
                    name: document.getElementById("project-name").value,
                    value: projectValue,
                    startDate: document.getElementById("project-start").value,
                    description: document.getElementById("project-description").value,
                    userId: currentUser.uid,
                    status: "active",
                    lastUpdate: new Date()
                };

                console.log("Salvando dados da obra:", projectData);
                await setDoc(doc(db, "projects", activeProjectId), projectData);
                showToast("Informações da obra salvas com sucesso!");
                await loadProjects();
                await updateReport();
            } catch (error) {
                console.error("Erro ao salvar obra:", error);
                showToast("Erro ao salvar informações da obra", true);
            }
        });

        // Limpar formulário de obra
        function clearProjectForm() {
            document.getElementById("project-name").value = "";
            document.getElementById("project-value").value = "0,00";
            document.getElementById("project-start").value = "";
            document.getElementById("project-description").value = "";
            document.getElementById("project-select").value = "";
        }

        // Carregar vales recebidos
        async function loadPayments() {
            if (!activeProjectId) return;
            try {
                const q = query(
                    collection(db, "payments"),
                    where("userId", "==", currentUser.uid),
                    where("projectId", "==", activeProjectId),
                    orderBy("date", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                const tbody = document.querySelector("#payments-table tbody");
                tbody.innerHTML = "";
                
                querySnapshot.forEach((doc) => {
                    const payment = doc.data();
                    console.log("Vale carregado:", payment);
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${formatDate(payment.date)}</td>
                        <td>${payment.description || ""}</td>
                        <td>${formatCurrency(payment.value || 0)}</td>
                        <td>
                            <button class="btn-danger delete-payment" data-id="${doc.id}">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                console.log("Total de vales carregados:", querySnapshot.size);
                await updateReport();
                setupDeleteButtons();
            } catch (error) {
                console.error("Erro ao carregar vales:", error);
                showToast("Erro ao carregar vales recebidos", true);
            }
        }

        // Adicionar vale
        document.getElementById("add-payment-btn").addEventListener("click", async () => {
            if (!activeProjectId) {
                showToast("Selecione uma obra antes de adicionar um vale!", true);
                return;
            }
            try {
                const paymentValueRaw = document.getElementById("payment-value").value;
                const paymentValue = parseFloat(paymentValueRaw.replace(/\./g, "").replace(",", ".")) || 0;
                const paymentDate = document.getElementById("payment-date").value;
                const paymentDescription = document.getElementById("payment-description").value;

                if (!paymentDate || !paymentDescription || isNaN(paymentValue) || paymentValue <= 0) {
                    showToast("Preencha todos os campos corretamente!", true);
                    return;
                }

                const paymentData = {
                    value: paymentValue,
                    date: paymentDate,
                    description: paymentDescription,
                    userId: currentUser.uid,
                    projectId: activeProjectId,
                    createdAt: new Date()
                };

                console.log("Salvando vale:", paymentData);
                await addDoc(collection(db, "payments"), paymentData);
                
                document.getElementById("payment-value").value = "0,00";
                document.getElementById("payment-date").value = "";
                document.getElementById("payment-description").value = "";
                
                showToast("Vale recebido cadastrado com sucesso!");
                await loadPayments();
            } catch (error) {
                console.error("Erro ao adicionar vale:", error);
                showToast("Erro ao cadastrar vale recebido", true);
            }
        });

        // Carregar serviços extras
        async function loadExtras() {
            if (!activeProjectId) return;
            try {
                const q = query(
                    collection(db, "extras"),
                    where("userId", "==", currentUser.uid),
                    where("projectId", "==", activeProjectId),
                    orderBy("date", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                const tbody = document.querySelector("#extras-table tbody");
                tbody.innerHTML = "";
                
                querySnapshot.forEach((doc) => {
                    const extra = doc.data();
                    console.log("Serviço extra carregado:", extra);
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${formatDate(extra.date)}</td>
                        <td>${extra.service || ""}</td>
                        <td>${formatCurrency(extra.value || 0)}</td>
                        <td>
                            <button class="btn-danger delete-extra" data-id="${doc.id}">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                console.log("Total de serviços extras carregados:", querySnapshot.size);
                await updateReport();
                setupDeleteButtons();
            } catch (error) {
                console.error("Erro ao carregar serviços extras:", error);
                showToast("Erro ao carregar serviços extras", true);
            }
        }

        // Adicionar serviço extra
        document.getElementById("add-extra-btn").addEventListener("click", async () => {
            if (!activeProjectId) {
                showToast("Selecione uma obra antes de adicionar um serviço extra!", true);
                return;
            }
            try {
                const extraService = document.getElementById("extra-service").value;
                const extraValueRaw = document.getElementById("extra-value").value;
                const extraValue = parseFloat(extraValueRaw.replace(/\./g, "").replace(",", ".")) || 0;
                const extraDate = document.getElementById("extra-date").value;

                if (!extraDate || !extraService || isNaN(extraValue) || extraValue <= 0) {
                    showToast("Preencha todos os campos corretamente!", true);
                    return;
                }

                const extraData = {
                    service: extraService,
                    value: extraValue,
                    date: extraDate,
                    userId: currentUser.uid,
                    projectId: activeProjectId,
                    createdAt: new Date()
                };

                console.log("Salvando serviço extra:", extraData);
                await addDoc(collection(db, "extras"), extraData);
                
                document.getElementById("extra-service").value = "";
                document.getElementById("extra-value").value = "0,00";
                document.getElementById("extra-date").value = "";
                
                showToast("Serviço extra cadastrado com sucesso!");
                await loadExtras();
            } catch (error) {
                console.error("Erro ao adicionar serviço extra:", error);
                showToast("Erro ao cadastrar serviço extra", true);
            }
        });

        // Carregar comprovantes PIX
        document.getElementById("receipt-file").addEventListener("change", (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                document.getElementById("file-name").textContent = selectedFile.name;
                
                if (selectedFile.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById("receipt-preview").src = e.target.result;
                        document.getElementById("receipt-preview").style.display = "block";
                    };
                    reader.readAsDataURL(selectedFile);
                }
            } else {
                document.getElementById("file-name").textContent = "Nenhum arquivo selecionado";
                document.getElementById("receipt-preview").style.display = "none";
            }
        });

        async function loadReceipts() {
            if (!activeProjectId) return;
            try {
                const q = query(
                    collection(db, "receipts"),
                    where("userId", "==", currentUser.uid),
                    where("projectId", "==", activeProjectId),
                    orderBy("createdAt", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                const tbody = document.querySelector("#receipts-table tbody");
                tbody.innerHTML = "";
                
                querySnapshot.forEach((doc) => {
                    const receipt = doc.data();
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${formatDate(receipt.createdAt)}</td>
                        <td>${receipt.description}</td>
                        <td>
                            ${receipt.fileUrl ? 
                                `<a href="${receipt.fileUrl}" target="_blank" class="btn">Visualizar</a>` : 
                                "Nenhum arquivo"}
                        </td>
                        <td>
                            <button class="btn-danger delete-receipt" data-id="${doc.id}">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                console.log("Total de comprovantes carregados:", querySnapshot.size);
                setupDeleteButtons();
            } catch (error) {
                console.error("Erro ao carregar comprovantes:", error);
                showToast("Erro ao carregar comprovantes", true);
            }
        }

        document.getElementById("add-receipt-btn").addEventListener("click", async () => {
            if (!activeProjectId) {
                showToast("Selecione uma obra antes de adicionar um comprovante!", true);
                return;
            }
            try {
                const description = document.getElementById("receipt-description").value;
                
                if (!description || !selectedFile) {
                    showToast("Preencha todos os campos e selecione um arquivo!", true);
                    return;
                }

                const storageRef = ref(storage, `receipts/${currentUser.uid}/${activeProjectId}/${Date.now()}_${selectedFile.name}`);
                const uploadTask = await uploadBytes(storageRef, selectedFile);
                const downloadURL = await getDownloadURL(uploadTask.ref);

                const receiptData = {
                    description: description,
                    fileUrl: downloadURL,
                    userId: currentUser.uid,
                    projectId: activeProjectId,
                    createdAt: new Date()
                };

                console.log("Salvando comprovante:", receiptData);
                await addDoc(collection(db, "receipts"), receiptData);
                
                document.getElementById("receipt-description").value = "";
                document.getElementById("receipt-file").value = "";
                document.getElementById("file-name").textContent = "Nenhum arquivo selecionado";
                document.getElementById("receipt-preview").style.display = "none";
                selectedFile = null;
                
                showToast("Comprovante cadastrado com sucesso!");
                await loadReceipts();
            } catch (error) {
                console.error("Erro ao salvar comprovante:", error);
                showToast("Erro ao cadastrar comprovante", true);
            }
        });

        // Atualizar relatório financeiro
        async function updateReport() {
            if (!activeProjectId) {
                document.getElementById("project-value-display").textContent = "R$ 0,00";
                document.getElementById("total-extras").textContent = "R$ 0,00";
                document.getElementById("total-value").textContent = "R$ 0,00";
                document.getElementById("total-received").textContent = "R$ 0,00";
                document.getElementById("balance").textContent = "R$ 0,00";
                return;
            }
            try {
                // Obter valor da obra
                const projectDocRef = doc(db, "projects", activeProjectId);
                const projectDocSnap = await getDoc(projectDocRef);
                const projectValue = projectDocSnap.exists() 
                    ? parseFloat(projectDocSnap.data().value) || 0 
                    : 0;

                console.log("Valor da obra:", projectValue);

                // Calcular total de vales recebidos
                let totalReceived = 0;
                const paymentsQuery = query(
                    collection(db, "payments"),
                    where("userId", "==", currentUser.uid),
                    where("projectId", "==", activeProjectId)
                );
                const paymentsSnapshot = await getDocs(paymentsQuery);
                paymentsSnapshot.forEach((doc) => {
                    const payment = doc.data();
                    console.log("Vale carregado:", payment);
                    totalReceived += parseFloat(payment.value) || 0;
                });

                console.log("Total de vales recebidos:", totalReceived);

                // Calcular total de serviços extras
                let totalExtras = 0;
                const extrasQuery = query(
                    collection(db, "extras"),
                    where("userId", "==", currentUser.uid),
                    where("projectId", "==", activeProjectId)
                );
                const extrasSnapshot = await getDocs(extrasQuery);
                extrasSnapshot.forEach((doc) => {
                    const extra = doc.data();
                    console.log("Serviço extra carregado:", extra);
                    totalExtras += parseFloat(extra.value) || 0;
                });

                console.log("Total de serviços extras:", totalExtras);

                // Calcular valor total (obra + extras)
                const totalValue = projectValue + totalExtras;

                // Calcular saldo
                const balance = totalValue - totalReceived;

                // Atualizar os elementos na tela
                document.getElementById("project-value-display").textContent = formatCurrency(projectValue);
                document.getElementById("total-extras").textContent = formatCurrency(totalExtras);
                document.getElementById("total-value").textContent = formatCurrency(totalValue);
                document.getElementById("total-received").textContent = formatCurrency(totalReceived);
                
                const balanceElement = document.getElementById("balance");
                balanceElement.textContent = formatCurrency(balance);
                balanceElement.style.color = balance >= 0 ? '#2ecc71' : '#e74c3c';

                console.log("Relatório atualizado:", { projectValue, totalExtras, totalValue, totalReceived, balance });
            } catch (error) {
                console.error("Erro ao atualizar relatório financeiro:", error);
                showToast("Erro ao atualizar relatório financeiro", true);
            }
        }

        // Gerar relatório PDF
        document.getElementById("generate-pdf-btn").addEventListener("click", async () => {
            if (!activeProjectId) {
                showToast("Selecione uma obra para gerar o relatório!", true);
                return;
            }
            try {
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.setTextColor(40, 40, 40);
                doc.text("Relatório Financeiro - Construtora JHS", 105, 15, { align: "center" });
                
                doc.setFontSize(12);
                doc.text(`Emitido em: ${new Date().toLocaleDateString("pt-BR")}`, 105, 25, { align: "center" });
                
                doc.setFontSize(14);
                doc.text("Informações da Obra", 14, 40);
                
                doc.setFontSize(12);
                doc.text(`Nome: ${document.getElementById("project-name").value || "Não informado"}`, 14, 50);
                doc.text(`Valor: ${document.getElementById("project-value-display").textContent}`, 14, 60);
                
                doc.setFontSize(14);
                doc.text("Vales Recebidos", 14, 80);
                
                const payments = [];
                document.querySelectorAll("#payments-table tbody tr").forEach(row => {
                    payments.push([
                        row.cells[0].textContent,
                        row.cells[1].textContent,
                        row.cells[2].textContent
                    ]);
                });
                
                if (payments.length > 0) {
                    doc.autoTable({
                        startY: 85,
                        head: [["Data", "Descrição", "Valor"]],
                        body: payments,
                        theme: "grid"
                    });
                } else {
                    doc.text("Nenhum vale registrado", 14, 85);
                }
                
                doc.setFontSize(14);
                doc.text("Serviços Extras", 14, doc.autoTable.previous.finalY + 15);
                
                const extras = [];
                document.querySelectorAll("#extras-table tbody tr").forEach(row => {
                    extras.push([
                        row.cells[0].textContent,
                        row.cells[1].textContent,
                        row.cells[2].textContent
                    ]);
                });
                
                if (extras.length > 0) {
                    doc.autoTable({
                        startY: doc.autoTable.previous.finalY + 20,
                        head: [["Data", "Serviço", "Valor"]],
                        body: extras,
                        theme: "grid"
                    });
                } else {
                    doc.text("Nenhum serviço extra registrado", 14, doc.autoTable.previous.finalY + 20);
                }
                
                doc.setFontSize(14);
                doc.text("Resumo Financeiro", 14, doc.autoTable.previous.finalY + 30);
                
                doc.setFontSize(12);
                doc.text(`Valor da Obra: ${document.getElementById("project-value-display").textContent}`, 14, doc.autoTable.previous.finalY + 40);
                doc.text(`Total Serviços Extras: ${document.getElementById("total-extras").textContent}`, 14, doc.autoTable.previous.finalY + 50);
                doc.text(`Valor Total: ${document.getElementById("total-value").textContent}`, 14, doc.autoTable.previous.finalY + 60);
                doc.text(`Total Vales Recebidos: ${document.getElementById("total-received").textContent}`, 14, doc.autoTable.previous.finalY + 70);
                
                const balance = document.getElementById("balance").textContent;
                const balanceColor = document.getElementById("balance").style.color;
                
                doc.setTextColor(balanceColor === 'rgb(46, 204, 113)' ? 46 : 231, balanceColor === 'rgb(46, 204, 113)' ? 204 : 76, balanceColor === 'rgb(46, 204, 113)' ? 113 : 60);
                doc.text(`Saldo: ${balance}`, 14, doc.autoTable.previous.finalY + 80);
                
                doc.save(`Relatorio_Construtora_JHS_${document.getElementById("project-name").value || "Obra"}_${new Date().toLocaleDateString("pt-BR")}.pdf`);
                showToast("Relatório PDF gerado com sucesso!");
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showToast("Erro ao gerar relatório PDF", true);
            }
        });

        // Configurar botões de exclusão
        function setupDeleteButtons() {
            document.querySelectorAll(".delete-payment").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir este vale?")) {
                        try {
                            await deleteDoc(doc(db, "payments", id));
                            showToast("Vale excluído com sucesso!");
                            await loadPayments();
                        } catch (error) {
                            console.error("Erro ao excluir vale:", error);
                            showToast("Erro ao excluir vale", true);
                        }
                    }
                });
            });
            
            document.querySelectorAll(".delete-extra").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir este serviço extra?")) {
                        try {
                            await deleteDoc(doc(db, "extras", id));
                            showToast("Serviço extra excluído com sucesso!");
                            await loadExtras();
                        } catch (error) {
                            console.error("Erro ao excluir serviço extra:", error);
                            showToast("Erro ao excluir serviço extra", true);
                        }
                    }
                });
            });
            
            document.querySelectorAll(".delete-receipt").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir este comprovante?")) {
                        try {
                            const docRef = doc(db, "receipts", id);
                            const docSnap = await getDoc(docRef);
                            
                            if (docSnap.exists()) {
                                const receipt = docSnap.data();
                                if (receipt.fileUrl) {
                                    const fileRef = ref(storage, receipt.fileUrl);
                                    await deleteObject(fileRef);
                                }
                                await deleteDoc(docRef);
                                showToast("Comprovante excluído com sucesso!");
                                await loadReceipts();
                            }
                        } catch (error) {
                            console.error("Erro ao excluir comprovante:", error);
                            showToast("Erro ao excluir comprovante", true);
                        }
                    }
                });
            });
        }

        // Formatadores
        function formatDate(dateString) {
            if (!dateString) return "Não informado";
            try {
                const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
                return date.toLocaleDateString("pt-BR");
            } catch (e) {
                console.error("Erro ao formatar data:", e, dateString);
                return "Data inválida";
            }
        }

        function formatCurrency(value) {
            const numValue = typeof value === 'string' ? 
                parseFloat(value.replace(/\./g, "").replace(",", ".")) : 
                Number(value);
            
            return new Intl.NumberFormat("pt-BR", {
                style: "currency",
                currency: "BRL"
            }).format(isNaN(numValue) ? 0 : numValue);
        }

        function formatCurrencyInputValue(value) {
            const numValue = typeof value === 'string' ? 
                parseFloat(value.replace(/\./g, "").replace(",", ".")) : 
                Number(value);
            
            return new Intl.NumberFormat("pt-BR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(isNaN(numValue) ? 0 : numValue).replace("R$", "").trim();
        }

        // Mostrar mensagens toast
        function showToast(message, isError = false) {
            const toast = document.createElement("div");
            toast.className = "toast " + (isError ? "error" : "success");
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add("fade-out");
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 3000);
        }

        // Função para formatar campos monetários durante a digitação
        function handleCurrencyInput(event) {
            let value = event.target.value.replace(/\D/g, "");
            
            if (value === "") {
                event.target.value = "0,00";
                return;
            }
            
            value = value.padStart(3, "0");
            value = value.replace(/(\d)(\d{2})$/, "$1,$2");
            value = value.replace(/(?=(\d{3})+(\D))\B/g, ".");
            
            event.target.value = value;
        }

        // Adiciona os event listeners para os campos monetários
        document.addEventListener("DOMContentLoaded", function() {
            const currencyInputs = document.querySelectorAll("input[type='text'][oninput*='formatCurrencyInput']");
            currencyInputs.forEach(input => {
                input.addEventListener("input", handleCurrencyInput);
                input.addEventListener("blur", function() {
                    if (this.value === "") {
                        this.value = "0,00";
                    }
                });
            });
        });
    </script>
    
    <!-- Biblioteca para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --gray: #bdc3c7;
            --light: #ecf0f1;
            --success: #2ecc71;
            --danger: #e74c3c;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--gray);
            margin: 0;
            padding: 0;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary);
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        button {
            padding: 10px 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .logout-btn {
            background: var(--danger);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
        }
        
        .file-upload {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .file-label {
            background: var(--light);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .file-name {
            color: #7f8c8d;
        }
        
        .receipt-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.5s forwards;
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast.fade-out {
            animation: fadeOut 0.5s forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Construtora JHS</h1>
        <button class="logout-btn" id="logout-btn">Sair</button>
    </header>
    
    <div class="container">
        <!-- 1. Informações da Obra -->
        <div class="card">
            <h2>Informações da Obra</h2>
            <div class="form-group">
                <label for="project-select">Selecionar Obra</label>
                <select id="project-select"></select>
            </div>
            <div class="form-group">
                <label for="project-name">Nome da Obra</label>
                <input type="text" id="project-name" placeholder="Ex: Casa Residencial">
            </div>
            <div class="form-group">
                <label for="project-value">Valor do Serviço (R$)</label>
                <input type="text" id="project-value" placeholder="0,00" value="0,00" oninput="handleCurrencyInput(event)">
            </div>
            <div class="form-group">
                <label for="project-start">Data de Início</label>
                <input type="date" id="project-start">
            </div>
            <div class="form-group">
                <label for="project-description">Descrição</label>
                <textarea id="project-description" rows="3" placeholder="Breve descrição"></textarea>
            </div>
            <button id="save-project-btn">Salvar Informações</button>
            <button id="new-project-btn" class="btn-success">Nova Obra</button>
            <button id="complete-project-btn" class="btn-danger">Concluir Obra</button>
        </div>
        
        <!-- 2. Vales Recebidos -->
        <div class="card">
            <h2>Vales Recebidos</h2>
            <div class="form-group">
                <label for="payment-value">Valor (R$)</label>
                <input type="text" id="payment-value" placeholder="0,00" value="0,00" oninput="handleCurrencyInput(event)">
            </div>
            <div class="form-group">
                <label for="payment-date">Data</label>
                <input type="date" id="payment-date">
            </div>
            <div class="form-group">
                <label for="payment-description">Descrição</label>
                <input type="text" id="payment-description" placeholder="Ex: Primeiro vale">
            </div>
            <button id="add-payment-btn">Adicionar Vale</button>
            
            <table id="payments-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- 3. Serviços Extras -->
        <div class="card">
            <h2>Serviços Extras</h2>
            <div class="form-group">
                <label for="extra-service">Descrição</label>
                <input type="text" id="extra-service" placeholder="Ex: Construção de muro">
            </div>
            <div class="form-group">
                <label for="extra-value">Valor (R$)</label>
                <input type="text" id="extra-value" placeholder="0,00" value="0,00" oninput="handleCurrencyInput(event)">
            </div>
            <div class="form-group">
                <label for="extra-date">Data</label>
                <input type="date" id="extra-date">
            </div>
            <button id="add-extra-btn">Adicionar Serviço</button>
            
            <table id="extras-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Serviço</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- 4. Comprovantes PIX -->
        <div class="card">
            <h2>Comprovantes PIX</h2>
            <div class="form-group">
                <label for="receipt-description">Descrição</label>
                <input type="text" id="receipt-description" placeholder="Ex: Comprovante do vale 1">
            </div>
            <div class="form-group">
                <label>Arquivo</label>
                <div class="file-upload">
                    <label for="receipt-file" class="file-label">Selecionar Arquivo</label>
                    <span class="file-name" id="file-name">Nenhum arquivo selecionado</span>
                    <input type="file" id="receipt-file" accept="image/*,.pdf">
                </div>
                <img id="receipt-preview" class="receipt-preview" alt="Pré-visualização">
            </div>
            <button id="add-receipt-btn">Adicionar Comprovante</button>
            
            <table id="receipts-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Arquivo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- 5. Relatório -->
        <div class="card">
            <h2>Relatório Financeiro</h2>
            <div id="report-summary">
                <p>Valor da Obra: <span id="project-value-display">R$ 0,00</span></p>
                <p>Total Serviços Extras: <span id="total-extras">R$ 0,00</span></p>
                <p>Valor Total (Obra + Extras): <span id="total-value">R$ 0,00</span></p>
                <p>Total Vales Recebidos: <span id="total-received">R$ 0,00</span></p>
                <p>Saldo: <span id="balance">R$ 0,00</span></p>
            </div>
            <button id="generate-pdf-btn" class="btn-success">Gerar PDF</button>
        </div>
    </div>
</body>
</html>
